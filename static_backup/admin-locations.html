<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Locations - ParkEase Admin</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="dashboard-grid" style="padding-top: 0;">

    <!-- Sidebar -->
    <aside class="sidebar">
        <a href="index.html" class="logo mb-2"><i class="fas fa-parking"></i> ParkEase</a>
        <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 2rem;">Admin Panel v1.0</p>
        
        <ul class="sidebar-menu">
            <li><a href="admin.html"><i class="fas fa-home"></i> Overview</a></li>
            <li><a href="admin-locations.html" class="active"><i class="fas fa-map-marker-alt"></i> Locations</a></li>
            <li><a href="#"><i class="fas fa-users"></i> Users</a></li>
            <li><a href="#"><i class="fas fa-file-invoice-dollar"></i> Revenue</a></li>
            <li><a href="#" onclick="logout()" style="color: var(--danger);"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="content">
        <div class="flex justify-between items-center mb-2">
            <div>
                <h1 style="font-size: 1.75rem;">Manage Locations</h1>
                <p style="color: var(--text-muted);">Add and manage your parking sites</p>
            </div>
            <button class="btn btn-primary" onclick="openModal()"><i class="fas fa-plus"></i> Add New Location</button>
        </div>

        <!-- Locations Grid -->
        <div id="locationsGrid" class="grid-3" style="gap: 1.5rem;">
            <!-- Loaded by JS -->
            <div class="card skeleton" style="height: 200px;"></div>
            <div class="card skeleton" style="height: 200px;"></div>
            <div class="card skeleton" style="height: 200px;"></div>
        </div>
    </main>

    <!-- Add Location Modal -->
    <div id="addModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px);">
        <div class="card animate-scale-up" style="width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-2">
                <h3>Add New Parking Site</h3>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;"><i class="fas fa-times"></i></button>
            </div>
            
            <form id="addLocationForm" class="flex flex-col gap-2">
                <div class="input-group">
                    <label>Location Name</label>
                    <input type="text" id="locName" class="input-field" required placeholder="e.g. Downtown Plaza Garage">
                </div>
                
                <div class="input-group">
                    <label>Address</label>
                    <input type="text" id="locAddress" class="input-field" required placeholder="e.g. 123 Main St">
                </div>

                <div class="flex gap-2">
                    <div class="input-group" style="flex: 1;">
                        <label>Price ($/hr)</label>
                        <input type="number" id="locPrice" class="input-field" required step="0.5" min="0">
                    </div>
                    <div class="input-group" style="flex: 1;">
                        <label>Total Slots</label>
                        <input type="number" id="locSlots" class="input-field" required min="1">
                    </div>
                </div>

                <div class="input-group">
                    <label>Image URL</label>
                    <input type="url" id="locImage" class="input-field" required placeholder="https://..." value="https://images.unsplash.com/photo-1573348722427-f1d6819fdf98?q=80&w=600&auto=format&fit=crop">
                </div>

                <div class="input-group">
                    <label>Description</label>
                    <textarea id="locDesc" class="input-field" rows="3" required placeholder="Short description of the parking site..."></textarea>
                </div>

                <div class="input-group">
                    <label>Features (Comma separated)</label>
                    <input type="text" id="locFeatures" class="input-field" placeholder="Covered, CCTV, EV Charging">
                </div>

                <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">Save Location</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { API } from './js/mock-api.js';
        import { showToast } from './js/app.js';

        // Auth Check
        const user = JSON.parse(localStorage.getItem('parkease_user'));
        if(!user || user.role !== 'admin') {
             alert('Access Denied');
             window.location.href = 'admin-login.html'; 
        }

        window.logout = () => {
            localStorage.removeItem('parkease_user');
            window.location.href = 'admin-login.html';
        }

        // Modal Logic
        window.openModal = () => {
            document.getElementById('addModal').style.display = 'flex';
        }

        window.closeModal = () => {
            document.getElementById('addModal').style.display = 'none';
        }

        // Load Locations
        const grid = document.getElementById('locationsGrid');
        
        async function loadLocations() {
            const locations = await API.getLocations();
            grid.innerHTML = '';
            
            locations.forEach(loc => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div style="height: 140px; background: url('${loc.image}') center/cover; border-radius: 12px; margin-bottom: 1rem; position: relative;">
                        <span style="position: absolute; top: 10px; right: 10px; background: white; padding: 2px 8px; border-radius: 4px; font-weight: 700; font-size: 0.8rem;">$${loc.price}/hr</span>
                    </div>
                    <h3>${loc.name}</h3>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;"><i class="fas fa-map-marker-alt"></i> ${loc.address}</p>
                    <div class="flex justify-between items-center" style="margin-top: auto;">
                        <span style="font-size: 0.85rem; font-weight: 600; color: ${loc.slots > 5 ? 'var(--success)' : 'var(--danger)'};">
                            <i class="fas fa-car"></i> ${loc.slots} Slots Available
                        </span>
                        <div class="flex gap-2">
                            <button class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteLocation('${loc.id}')" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; color: var(--danger); border-color: var(--danger);"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        loadLocations();

        // Add Logic
        document.getElementById('addLocationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const features = document.getElementById('locFeatures').value.split(',').map(f => f.trim()).filter(f => f);
            
            const newLoc = {
                name: document.getElementById('locName').value,
                address: document.getElementById('locAddress').value,
                price: parseFloat(document.getElementById('locPrice').value),
                slots: parseInt(document.getElementById('locSlots').value),
                image: document.getElementById('locImage').value,
                desc: document.getElementById('locDesc').value,
                features: features,
                reviews: 5.0 // Fresh start
            };

            const res = await API.addLocation(newLoc);
            if(res.success) {
                showToast('Location Added Successfully', 'success');
                closeModal();
                loadLocations();
                e.target.reset();
            } else {
                showToast('Failed to add location', 'error');
            }
        });
        
        // Mock Delete (exposed to window)
        window.deleteLocation = async (id) => {
            if(confirm('Are you sure you want to delete this location?')) {
                await API.deleteLocation(id);
                loadLocations();
                showToast('Location removed', 'success');
            }
        }

    </script>
</body>
</html>
