<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParkEase | Admin Portal</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body style="background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1.5rem;">

    <div class="card animate-scale-up" style="width: 100%; max-width: 420px; padding: 2.5rem; background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); color: white;">
        <div class="text-center mb-2">
            <a href="index.html" class="logo justify-center mb-2" style="justify-content: center; font-size: 2rem; color: #60a5fa;"><i class="fas fa-parking"></i> ParkEase</a>
            <h2 id="title" style="color: white; font-size: 1.5rem;">Admin Access</h2>
            <p style="color: #94a3b8; margin-top: 0.5rem; font-size: 0.95rem;">Authorized personnel only</p>
        </div>
        
        <form id="authForm" class="flex flex-col gap-2" style="margin-top: 2rem;">
            <div class="input-group" style="padding: 0; border: none; margin-bottom: 1.5rem;">
                <label style="margin-bottom: 0.5rem; color: #94a3b8;">Administrator Email</label>
                <div style="position: relative;">
                    <i class="fas fa-envelope" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #64748b;"></i>
                    <input type="email" id="email" class="input-field" required placeholder="admin@parkease.com" style="padding: 1rem 1rem 1rem 3rem; background: #334155; border: 1px solid #475569; border-radius: 12px; color: white;">
                </div>
            </div>

            <div class="input-group" style="padding: 0; border: none; margin-bottom: 1.5rem;">
                <label style="margin-bottom: 0.5rem; color: #94a3b8;">Password</label>
                <div style="position: relative;">
                    <i class="fas fa-lock" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #64748b;"></i>
                    <input type="password" id="password" class="input-field" required placeholder="••••••••" style="padding: 1rem 1rem 1rem 3rem; background: #334155; border: 1px solid #475569; border-radius: 12px; color: white;">
                </div>
            </div>

            <!-- Admin Secret Code (Required for Registration) -->
            <div id="adminCodeGroup" class="input-group" style="padding: 0; border: none; margin-bottom: 1.5rem; display: none;">
                <label style="margin-bottom: 0.5rem; color: #94a3b8;">Secret Clearance Code</label>
                <div style="position: relative;">
                    <i class="fas fa-shield-alt" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #64748b;"></i>
                    <input type="password" id="adminCode" class="input-field" placeholder="Clearance Code" style="padding: 1rem 1rem 1rem 3rem; background: #334155; border: 1px solid #475569; border-radius: 12px; color: white;">
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary w-full" id="submitBtn" style="padding: 1rem; font-size: 1rem; background: #3b82f6; border: none;">
                Authenticate <i class="fas fa-fingerprint" style="margin-left: 0.5rem;"></i>
            </button>
        </form>

        <p class="text-center mt-2" style="font-size: 0.95rem; color: #94a3b8; margin-top: 2rem;">
            <span id="toggleText">Need access?</span> 
            <a href="#" id="toggleLink" style="color: #60a5fa; font-weight: 600; text-decoration: none; margin-left: 0.5rem;">Register Admin</a>
        </p>
        
        <div class="text-center mt-2">
             <a href="login.html" style="color: #64748b; font-size: 0.85rem; text-decoration: none;">← Back to User Login</a>
        </div>
    </div>

    <script type="module">
        import { API } from './js/mock-api.js';
        import { showToast, initAuth } from './js/app.js';

        // Redirect if already logged in as Admin
        const storedUser = JSON.parse(localStorage.getItem('parkease_user'));
        if(storedUser && storedUser.role === 'admin'){
            window.location.href = 'admin.html';
        }

        const form = document.getElementById('authForm');
        const title = document.getElementById('title');
        const submitBtn = document.getElementById('submitBtn');
        const toggleLink = document.getElementById('toggleLink');
        const toggleText = document.getElementById('toggleText');
        const adminCodeGroup = document.getElementById('adminCodeGroup');
        const adminCodeInput = document.getElementById('adminCode');

        let isLogin = true;

        toggleLink.addEventListener('click', (e) => {
            e.preventDefault();
            isLogin = !isLogin;
            title.innerText = isLogin ? 'Admin Access' : 'Register Admin';
            submitBtn.innerHTML = isLogin ? 'Authenticate <i class="fas fa-fingerprint" style="margin-left: 0.5rem;"></i>' : 'Create Admin <i class="fas fa-user-shield" style="margin-left: 0.5rem;"></i>';
            toggleText.innerText = isLogin ? "Need access?" : "Have credentials?";
            toggleLink.innerText = isLogin ? 'Register Admin' : 'Login';
            
            // Show Admin Secret Code only on Register
            adminCodeGroup.style.display = isLogin ? 'none' : 'block';
            if(!isLogin) adminCodeInput.setAttribute('required', 'true');
            else adminCodeInput.removeAttribute('required');

            // Animation reset
            form.style.animation = 'none';
            form.offsetHeight; /* trigger reflow */
            form.style.animation = 'fadeIn 0.5s ease';
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const secret = document.getElementById('adminCode').value;

            const originalBtnContent = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Verifying...';
            
            try {
                await new Promise(r => setTimeout(r, 1000));

                let res;
                if(isLogin) {
                    res = await API.login(email, pass);
                    // Additional check for admin login
                    if(res.success && res.user.role !== 'admin') {
                         showToast("Access Denied. Not an Administrator account.", "error");
                         // Optional: logout logic
                         API.logout(); 
                         submitBtn.disabled = false;
                         submitBtn.innerHTML = originalBtnContent;
                         return;
                    }
                } else {
                    res = await API.register(email, pass, secret);
                    // Check if role became admin
                    // (Mock-API Logic: Only if code matches "ADMIN2026" does it return "Admin Account created!")
                    // But API register returns success even if role fallback to User if code is wrong.
                }

                if(res.success) {
                    // Double check registration result message to confirm admin role creation
                    if(!isLogin && !res.message.includes('Admin')) {
                         showToast("Registration Failed: Invalid Secret Code. Account created as User.", "error");
                         // If we accidentally created a user, maybe auto-logout or redirect to user login?
                         // For now let's just show error.
                         submitBtn.disabled = false;
                         submitBtn.innerHTML = originalBtnContent;
                         return;
                    }

                    showToast(isLogin ? "Clearance Verify. Welcome." : "Admin Registered Successfully!", "success");
                    
                    if(isLogin && res.user) {
                        localStorage.setItem('parkease_user', JSON.stringify(res.user));
                    }
                    // For register, usually we ask to login again.
                    if(!isLogin) {
                         setTimeout(() => window.location.reload(), 1500); // Reload to login mode
                    } else {
                         setTimeout(() => window.location.href = 'admin.html', 1000);
                    }
                    
                } else {
                    showToast(res.message || "Invalid credentials", "error");
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnContent;
                }

            } catch(err) {
                console.error(err);
                showToast("System Error.", "error");
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
            }
        });

    </script>
</body>
</html>
